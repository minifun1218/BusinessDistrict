# åŸå¸‚å•†åœˆæ¶ˆè´¹çƒ­åº¦å¯è§†åŒ–åˆ†æç³»ç»Ÿ - Flask API

åŸºäºFlaskæ„å»ºçš„åŸå¸‚å•†åœˆæ¶ˆè´¹çƒ­åº¦åˆ†æç³»ç»Ÿåç«¯APIæœåŠ¡ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- pip åŒ…ç®¡ç†å™¨
- SQLiteï¼ˆé»˜è®¤ï¼‰æˆ– MySQLï¼ˆå¯é€‰ï¼‰
- Redisï¼ˆå¯é€‰ï¼Œç”¨äºç¼“å­˜ï¼‰

### å®‰è£…ä¾èµ–

```bash
cd web
pip install -r requirements.txt
```

### åˆå§‹åŒ–æ•°æ®åº“

```bash
python data/init_data.py
```

### å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1: ä½¿ç”¨å¯åŠ¨è„šæœ¬
python run.py

# æ–¹å¼2: ä½¿ç”¨Flaskå‘½ä»¤
python app.py

# æ–¹å¼3: ä½¿ç”¨gunicornï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
gunicorn -w 4 -b 127.0.0.1:3000 app:app
```

æœåŠ¡å¯åŠ¨åè®¿é—®ï¼š
- APIæœåŠ¡ï¼šhttp://127.0.0.1:3000
- APIæ–‡æ¡£ï¼šhttp://127.0.0.1:3000/api/docs
- å¥åº·æ£€æŸ¥ï¼šhttp://127.0.0.1:3000/api/health

## ğŸ“ é¡¹ç›®ç»“æ„

```
web/
â”œâ”€â”€ app/                    # Flaskåº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py        # åº”ç”¨å·¥å‚å‡½æ•°
â”‚   â”œâ”€â”€ extensions.py      # Flaskæ‰©å±•åˆå§‹åŒ–
â”‚   â”œâ”€â”€ api/               # APIè“å›¾
â”‚   â”‚   â”œâ”€â”€ auth.py       # è®¤è¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ cities.py     # åŸå¸‚æ¥å£
â”‚   â”‚   â”œâ”€â”€ business.py   # å•†åœˆæ¥å£
â”‚   â”‚   â””â”€â”€ analytics.py  # æ•°æ®åˆ†ææ¥å£
â”‚   â”œâ”€â”€ models/           # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py       # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ city.py       # åŸå¸‚æ¨¡å‹
â”‚   â”‚   â””â”€â”€ business_area.py # å•†åœˆæ¨¡å‹
â”‚   â””â”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ response.py   # å“åº”æ ¼å¼åŒ–
â”‚       â””â”€â”€ auth.py       # è®¤è¯å·¥å…·
â”œâ”€â”€ config/               # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ config.py        # åº”ç”¨é…ç½®
â”œâ”€â”€ data/                # æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ init_data.py     # æ•°æ®åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ static/              # é™æ€æ–‡ä»¶
â”œâ”€â”€ templates/           # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ tests/               # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ app.py              # åº”ç”¨å…¥å£
â”œâ”€â”€ run.py              # å¯åŠ¨è„šæœ¬
â””â”€â”€ requirements.txt    # ä¾èµ–åˆ—è¡¨
```

## ğŸ”Œ APIæ¥å£

### è®¤è¯æ¥å£ (/api/auth)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | `/login` | ç”¨æˆ·ç™»å½• |
| POST | `/register` | ç”¨æˆ·æ³¨å†Œ |
| GET | `/user` | è·å–ç”¨æˆ·ä¿¡æ¯ |
| PUT | `/user` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| POST | `/refresh` | åˆ·æ–°ä»¤ç‰Œ |
| POST | `/logout` | é€€å‡ºç™»å½• |
| PUT | `/password` | ä¿®æ”¹å¯†ç  |

### åŸå¸‚æ¥å£ (/api/cities)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| GET | `/` | è·å–åŸå¸‚åˆ—è¡¨ |
| GET | `/hot` | è·å–çƒ­é—¨åŸå¸‚ |
| GET | `/{city_id}` | è·å–åŸå¸‚è¯¦æƒ… |
| GET | `/search` | æœç´¢åŸå¸‚ |
| GET | `/location` | æ ¹æ®åæ ‡è·å–åŸå¸‚ |
| GET | `/provinces` | è·å–çœä»½åˆ—è¡¨ |
| GET | `/{city_id}/stats` | è·å–åŸå¸‚ç»Ÿè®¡ |

### å•†åœˆæ¥å£ (/api/business-areas)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| GET | `/` | è·å–å•†åœˆåˆ—è¡¨ |
| GET | `/{area_id}` | è·å–å•†åœˆè¯¦æƒ… |
| GET | `/search` | æœç´¢å•†åœˆ |
| GET | `/hot-ranking` | è·å–çƒ­åº¦æ’è¡Œ |
| GET | `/{area_id}/stats` | è·å–å•†åœˆç»Ÿè®¡ |
| GET | `/{area_id}/stores` | è·å–å•†åœˆåº—é“º |
| POST | `/compare` | å•†åœˆå¯¹æ¯” |
| GET | `/nearby` | è·å–é™„è¿‘å•†åœˆ |

### æ•°æ®åˆ†ææ¥å£ (/api/analytics)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| GET | `/city/{city_id}` | è·å–åŸå¸‚åˆ†ææ•°æ® |
| GET | `/hot-ranking` | è·å–çƒ­åº¦æ’è¡Œæ•°æ® |
| GET | `/hourly-flow` | è·å–24å°æ—¶å®¢æµæ•°æ® |
| GET | `/category-distribution` | è·å–æ¶ˆè´¹ç±»å‹åˆ†å¸ƒ |
| GET | `/sentiment-analysis` | è·å–æƒ…æ„Ÿåˆ†ææ•°æ® |
| GET | `/consumption-trend` | è·å–æ¶ˆè´¹è¶‹åŠ¿æ•°æ® |
| POST | `/radar-comparison` | è·å–é›·è¾¾å›¾å¯¹æ¯”æ•°æ® |
| GET | `/heatmap` | è·å–çƒ­åŠ›å›¾æ•°æ® |
| GET | `/realtime/{city_id}` | è·å–å®æ—¶æ•°æ® |

## ğŸ“Š æ•°æ®æ¨¡å‹

### ç”¨æˆ·æ¨¡å‹ (User)
- åŸºæœ¬ä¿¡æ¯ï¼šç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºå·
- ä¸ªäººèµ„æ–™ï¼šæ˜µç§°ã€å¤´åƒã€æ€§åˆ«ã€å¹´é¾„ã€åŸå¸‚
- çŠ¶æ€ä¿¡æ¯ï¼šæ¿€æ´»çŠ¶æ€ã€VIPç­‰çº§ã€ç§¯åˆ†

### åŸå¸‚æ¨¡å‹ (City)
- åŸºæœ¬ä¿¡æ¯ï¼šåç§°ã€ä»£ç ã€çº§åˆ«ï¼ˆçœ/å¸‚/åŒºï¼‰
- åœ°ç†ä¿¡æ¯ï¼šç»çº¬åº¦åæ ‡
- ç»Ÿè®¡ä¿¡æ¯ï¼šäººå£ã€é¢ç§¯ã€ç»æµæ°´å¹³

### å•†åœˆæ¨¡å‹ (BusinessArea)
- åŸºæœ¬ä¿¡æ¯ï¼šåç§°ã€ç±»å‹ã€çº§åˆ«
- åœ°ç†ä¿¡æ¯ï¼šç»çº¬åº¦ã€é¢ç§¯
- ä¸šåŠ¡æ•°æ®ï¼šçƒ­åº¦å€¼ã€å¹³å‡æ¶ˆè´¹ã€å®¢æµé‡ã€è¯„åˆ†
- æ‰©å±•ä¿¡æ¯ï¼šé…å¥—è®¾æ–½ã€äº¤é€šä¿¡æ¯ã€æ ‡ç­¾

### åº—é“ºæ¨¡å‹ (Store)
- åŸºæœ¬ä¿¡æ¯ï¼šåç§°ã€åˆ†ç±»ã€å­åˆ†ç±»
- åœ°ç†ä¿¡æ¯ï¼šç»çº¬åº¦
- ä¸šåŠ¡æ•°æ®ï¼šè¯„åˆ†ã€è¯„ä»·æ•°ã€å¹³å‡ä»·æ ¼
- è”ç³»ä¿¡æ¯ï¼šç”µè¯ã€åœ°å€ã€è¥ä¸šæ—¶é—´

## ğŸ”§ é…ç½®è¯´æ˜

### æ•°æ®åº“é…ç½®

é»˜è®¤ä½¿ç”¨SQLiteæ•°æ®åº“ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨MySQLï¼š

```python
# SQLiteï¼ˆé»˜è®¤ï¼‰
DATABASE_URL = 'sqlite:///business_district.db'

# MySQL
DATABASE_URL = 'mysql+pymysql://username:password@localhost/business_district'
```

### JWTé…ç½®

```python
JWT_SECRET_KEY = 'your-jwt-secret-key'
JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=24)
JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)
```

### CORSé…ç½®

å·²é…ç½®å…è®¸å‰ç«¯è·¨åŸŸè®¿é—®ï¼š

```python
CORS(app, 
     origins=['http://localhost:5173', 'http://127.0.0.1:5173'],
     supports_credentials=True)
```

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•è´¦å·

ç³»ç»Ÿé¢„ç½®äº†ä»¥ä¸‹æµ‹è¯•è´¦å·ï¼š

- **ç®¡ç†å‘˜**: `admin` / `admin123`
- **æ¼”ç¤ºç”¨æˆ·**: `demo` / `demo123`

### APIæµ‹è¯•

ä½¿ç”¨curlæµ‹è¯•APIï¼š

```bash
# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:3000/api/health

# ç”¨æˆ·ç™»å½•
curl -X POST http://127.0.0.1:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"demo","password":"demo123"}'

# è·å–åŸå¸‚åˆ—è¡¨
curl http://127.0.0.1:3000/api/cities

# è·å–å•†åœˆçƒ­åº¦æ’è¡Œ
curl "http://127.0.0.1:3000/api/analytics/hot-ranking?cityId=beijing"
```

## ğŸš€ éƒ¨ç½²

### å¼€å‘ç¯å¢ƒ

```bash
python run.py
```

### ç”Ÿäº§ç¯å¢ƒ

ä½¿ç”¨gunicornéƒ¨ç½²ï¼š

```bash
# å®‰è£…gunicorn
pip install gunicorn

# å¯åŠ¨æœåŠ¡
gunicorn -w 4 -b 0.0.0.0:3000 app:app

# ä½¿ç”¨é…ç½®æ–‡ä»¶
gunicorn -c gunicorn.conf.py app:app
```

### Dockeréƒ¨ç½²

```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 3000

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:3000", "app:app"]
```

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„APIæ¥å£

1. åœ¨å¯¹åº”çš„è“å›¾æ–‡ä»¶ä¸­æ·»åŠ è·¯ç”±å‡½æ•°
2. ä½¿ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼ˆ`success_response`, `error_response`ï¼‰
3. æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯
4. æ›´æ–°APIæ–‡æ¡£

### æ•°æ®åº“è¿ç§»

```bash
# åˆå§‹åŒ–è¿ç§»
flask db init

# ç”Ÿæˆè¿ç§»æ–‡ä»¶
flask db migrate -m "Add new table"

# åº”ç”¨è¿ç§»
flask db upgrade
```

### æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹

1. åœ¨`app/models/`ç›®å½•ä¸‹åˆ›å»ºæ¨¡å‹æ–‡ä»¶
2. åœ¨`app/__init__.py`ä¸­å¯¼å…¥æ¨¡å‹
3. è¿è¡Œæ•°æ®åº“è¿ç§»

## ğŸ¤ è´¡çŒ®

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚
